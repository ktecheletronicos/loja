<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta property="og:title" content="KTech — Catálogo Oficial">
<meta property="og:description" content="Ofertas atualizadas, retirada no local e entrega rápida. Clique e escolha seus produtos!">
<meta property="og:image" content="https://ktecheletronicos.github.io/loja/ktech_preview_catalogo_oficial.png">
<meta property="og:url" content="https://ktecheletronicos.github.io/loja/">
<meta property="og:type" content="website">
<title>KTech - Eletrônicos</title>
<link rel="icon" type="image/png" href="https://ktecheletronicos.github.io/ktechfiles/logo_k.png">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="estilo.css">
</head>
<body>
<!-- HEADER -->
<header class="header">
  <img src="https://ktecheletronicos.github.io/ktechfiles/logo_ktech_eletronicos.png" alt="KTech Logo" class="logo">
  <h1>KTech Eletrônicos</h1>
  <div class="search-container">
    <input type="text" class="search-input" id="searchInput" placeholder="🔍 Buscar produtos...">
  </div>
  <button class="cart-button" id="cartToggle">
    🛒
    <span class="cart-count hidden" id="cartCount">0</span>
  </button>
</header>

<!-- PRODUTOS -->
<main class="products-container">
  <div id="loadingSpinner" class="loading">
    <div class="spinner"></div>
  </div>
  <div class="products-grid" id="productsGrid"></div>
</main>

<!-- CARRINHO OVERLAY -->
<div class="cart-overlay" id="cartOverlay"></div>

<!-- CARRINHO PANEL -->
<aside class="cart-panel" id="cartPanel">
  <div class="cart-header">
    <h2 class="cart-title">Meu Carrinho</h2>
    <button class="cart-close" id="cartClose">← Voltar</button>
  </div>
  
  <div class="cart-items" id="cartItems">
    <div class="cart-empty">Carrinho vazio</div>
  </div>
  
  <div class="cart-form">
    <!-- Opções de entrega -->
    <div class="delivery-options">
      <label>Como deseja receber?</label>
      <div class="radio-group">
        <label class="radio-option">
          <input type="radio" name="deliveryOption" value="RETIRADA" checked>
          🏪 Retirar na loja
        </label>
        <label class="radio-option">
          <input type="radio" name="deliveryOption" value="ENTREGA">
          🚚 Entrega em casa
        </label>
      </div>
    </div>

    <!-- Formulário de entrega -->
    <div id="deliveryForm" class="hidden">
      <div id="map" class="map-container"></div>
      
      <!-- INSTRUÇÃO DESTACADA DO MAPA -->
      <div class="map-instruction">
        <span class="map-instruction-icon">📍</span>
        <strong>IMPORTANTE:</strong> Arraste o pino azul no mapa até o local exato da sua entrega!
      </div>
      
      <label>Tipo de endereço:</label>
      <div class="radio-group" style="margin-bottom: 12px;">
        <label class="radio-option">
          <input type="radio" name="tipoEndereco" value="CASA">
          🏠 Casa
        </label>
        <label class="radio-option">
          <input type="radio" name="tipoEndereco" value="CONDOMINIO">
          🏘️ Condomínio
        </label>
        <label class="radio-option">
          <input type="radio" name="tipoEndereco" value="EMPRESA">
          🏢 Empresa
        </label>
      </div>
      
      <div id="empresaContainer" class="hidden">
        <input type="text" class="form-input" id="empresaOuCondominio" placeholder="Nome da empresa ou condomínio">
      </div>
      
      <input type="text" class="form-input" id="street" placeholder="Rua, Quadra ou Avenida">
      <div style="display: flex; gap: 12px;">
        <input type="text" class="form-input" id="houseNumber" placeholder="Número" style="flex: 1;">
        <input type="text" class="form-input" id="neighborhood" placeholder="Bairro" style="flex: 2;">
      </div>
      <input type="hidden" id="city">
    </div>

    <!-- Dados do cliente -->
    <form id="customerForm">
      <input type="text" class="form-input" id="customerName" placeholder="Nome completo *" required>
      <div class="form-error" id="nameError">Nome deve ter pelo menos 12 caracteres (nome e sobrenome)</div>
      
      <select class="form-select" id="paymentMethod" required>
        <option value="">Forma de Pagamento *</option>
        <option value="PIX">💰 PIX</option>
        <option value="Dinheiro">💵 Dinheiro</option>
        <option value="Cartão">💳 Cartão (taxa adicional)</option>
        <option value="Link">📱 Link de Pagamento (taxa adicional)</option>
      </select>
      
      <textarea class="form-textarea" id="observations" placeholder="Observações (opcional)" rows="3"></textarea>
      
      <button type="submit" class="whatsapp-button" id="whatsappBtn" disabled>
        📱 Orçamento via WhatsApp
      </button>
    </form>
  </div>
</aside>

<!-- FLOATING CART BUTTON -->
<button class="floating-cart" id="floatingCart">
  🛒 Carrinho (<span id="floatingCount">0</span>)
</button>

<!-- MODAL DE IMAGEM -->
<div class="modal" id="imageModal">
  <img id="modalImage" src="" alt="Produto">
  <button class="modal-close" id="modalClose">✕</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
class KTechStore {
  constructor() {
    this.products = [];
    this.cart = [];
    this.selectedLocation = null;
    this.map = null;
    this.marker = null;
    this.customerNameFromUrl = null;
    this.addressFetchTimeout = null;
    
    this.initializeElements();
    this.getUrlParameters();
    this.loadCartFromCache();
    this.setupNameFieldFromUrl();
    this.updateCart(); // Atualizar carrinho após carregar do cache
    this.bindEvents();
    this.loadProducts();
  }
  
  getUrlParameters() {
    const urlParams = new URLSearchParams(window.location.search);
    this.customerNameFromUrl = urlParams.get('name');
    
    if (this.customerNameFromUrl) {
      console.log('Nome recebido via URL:', this.customerNameFromUrl);
    }
  }
  
  setupNameFieldFromUrl() {
    if (this.customerNameFromUrl) {
      // Preencher campo automaticamente
      if (this.customerName) {
        this.customerName.value = this.customerNameFromUrl;
        // Ocultar APENAS o campo de nome (input)
        this.customerName.style.display = 'none';
        // Ocultar APENAS a mensagem de erro do nome
        const nameError = document.getElementById('nameError');
        if (nameError) {
          nameError.style.display = 'none';
        }
      }
    }
  }
  
  saveCartToCache() {
    const cartData = {
      cart: this.cart,
      timestamp: Date.now()
    };
    try {
      localStorage.setItem('ktech_cart', JSON.stringify(cartData));
    } catch (error) {
      console.error('Erro ao salvar carrinho no cache:', error);
    }
  }
  
  loadCartFromCache() {
    try {
      const cartData = localStorage.getItem('ktech_cart');
      if (cartData) {
        const parsed = JSON.parse(cartData);
        const now = Date.now();
        const thirtyHours = 30 * 60 * 60 * 1000; // 30 horas em millisegundos
        
        if (now - parsed.timestamp < thirtyHours) {
          this.cart = parsed.cart || [];
          console.log('Carrinho carregado do cache:', this.cart.length, 'itens');
        } else {
          // Cache expirou, limpar
          localStorage.removeItem('ktech_cart');
          console.log('Cache do carrinho expirou, limpando...');
        }
      }
    } catch (error) {
      console.error('Erro ao carregar carrinho do cache:', error);
      localStorage.removeItem('ktech_cart');
    }
  }
  
  clearCartCache() {
    try {
      localStorage.removeItem('ktech_cart');
    } catch (error) {
      console.error('Erro ao limpar cache do carrinho:', error);
    }
  }
  
  initializeElements() {
    // Header elements
    this.searchInput = document.getElementById('searchInput');
    this.cartToggle = document.getElementById('cartToggle');
    this.cartCount = document.getElementById('cartCount');
    
    // Products
    this.productsGrid = document.getElementById('productsGrid');
    this.loadingSpinner = document.getElementById('loadingSpinner');
    
    // Cart
    this.cartOverlay = document.getElementById('cartOverlay');
    this.cartPanel = document.getElementById('cartPanel');
    this.cartClose = document.getElementById('cartClose');
    this.cartItems = document.getElementById('cartItems');
    this.floatingCart = document.getElementById('floatingCart');
    this.floatingCount = document.getElementById('floatingCount');
    
    // Form
    this.deliveryForm = document.getElementById('deliveryForm');
    this.customerForm = document.getElementById('customerForm');
    this.customerName = document.getElementById('customerName');
    this.paymentMethod = document.getElementById('paymentMethod');
    this.whatsappBtn = document.getElementById('whatsappBtn');
    
    // Modal
    this.imageModal = document.getElementById('imageModal');
    this.modalImage = document.getElementById('modalImage');
    this.modalClose = document.getElementById('modalClose');
  }
  
  bindEvents() {
    // Search
    this.searchInput.addEventListener('input', (e) => this.handleSearch(e.target.value));
    
    // Cart toggle
    this.cartToggle.addEventListener('click', (e) => {
      e.stopPropagation();
      this.openCart();
    });
    
    this.floatingCart.addEventListener('click', (e) => {
      e.stopPropagation();
      this.openCart();
    });
    
    // Cart close
    this.cartClose.addEventListener('click', (e) => {
      e.stopPropagation();
      this.closeCart();
    });
    
    this.cartOverlay.addEventListener('click', () => this.closeCart());
    
    // Prevent cart close when clicking inside panel
    this.cartPanel.addEventListener('click', (e) => e.stopPropagation());
    
    // Delivery options
    document.querySelectorAll('input[name="deliveryOption"]').forEach(radio => {
      radio.addEventListener('change', (e) => this.handleDeliveryOption(e.target.value));
    });
    
    document.querySelectorAll('input[name="tipoEndereco"]').forEach(radio => {
      radio.addEventListener('change', (e) => this.handleAddressType(e.target.value));
    });
    
    // Form validation
    this.customerName.addEventListener('input', () => this.validateForm());
    this.paymentMethod.addEventListener('change', () => this.validateForm());
    
    // Form submit
    this.customerForm.addEventListener('submit', (e) => this.handleFormSubmit(e));
    
    // Modal
    this.modalClose.addEventListener('click', () => this.closeModal());
    this.imageModal.addEventListener('click', (e) => {
      if (e.target === this.imageModal) this.closeModal();
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (this.imageModal.classList.contains('active')) {
          this.closeModal();
        } else if (this.cartPanel.classList.contains('active')) {
          this.closeCart();
        }
      }
    });
  }
  
  async loadProducts() {
    try {
      this.showLoading(true);
      const response = await fetch('https://webhookn8n.ktecheletronicos.com.br/webhook/produtos');
      const data = await response.json();
      
      this.products = Array.isArray(data) ? data.filter(p => p.PRODUTO && p.FOTO) : [];
      this.renderProducts(this.products);
    } catch (error) {
      console.error('Erro ao carregar produtos:', error);
      this.showError('Erro ao carregar produtos. Tente novamente.');
    } finally {
      this.showLoading(false);
    }
  }
  
  showLoading(show) {
    this.loadingSpinner.style.display = show ? 'flex' : 'none';
    this.productsGrid.style.display = show ? 'none' : 'grid';
  }
  
  showError(message) {
    this.productsGrid.innerHTML = `
      <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--gray);">
        <div style="font-size: 48px; margin-bottom: 16px;">⚠️</div>
        <div style="font-size: 18px;">${message}</div>
      </div>
    `;
  }
  
  renderProducts(products) {
    if (products.length === 0) {
      this.productsGrid.innerHTML = `
        <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--gray);">
          <div style="font-size: 48px; margin-bottom: 16px;">🔍</div>
          <div style="font-size: 18px;">Nenhum produto encontrado</div>
        </div>
      `;
      return;
    }
    
    this.productsGrid.innerHTML = '';
    
    products.forEach(product => {
      const cartItem = this.cart.find(item => item.PRODUTO === product.PRODUTO);
      const inCart = !!cartItem;
      
      const card = document.createElement('div');
      card.className = 'product-card fade-in';
      
      card.innerHTML = `
        <img src="${product.FOTO}" alt="${this.escapeHtml(product.PRODUTO)}" class="product-image">
        <h3 class="product-title">${this.escapeHtml(product.PRODUTO)}</h3>
        
        ${inCart ? `
          <div class="quantity-controls">
            <button class="qty-button minus-btn" data-product="${this.escapeHtml(product.PRODUTO)}">−</button>
            <span class="qty-display">${cartItem.quantity}</span>
            <button class="qty-button plus-btn" data-product="${this.escapeHtml(product.PRODUTO)}">+</button>
          </div>
          <button class="product-button btn-remove" data-product="${this.escapeHtml(product.PRODUTO)}">Remover do Carrinho</button>
        ` : `
          <button class="product-button btn-add" data-product="${this.escapeHtml(product.PRODUTO)}">Adicionar ao Carrinho</button>
        `}
      `;
      
      // Image click event
      const img = card.querySelector('.product-image');
      img.addEventListener('click', (e) => {
        e.stopPropagation();
        this.openModal(product.FOTO);
      });
      
      // Button events
      const button = card.querySelector('.product-button');
      button.addEventListener('click', (e) => {
        e.stopPropagation();
        this.toggleCartItem(product.PRODUTO);
      });
      
      // Quantity controls
      const minusBtn = card.querySelector('.minus-btn');
      const plusBtn = card.querySelector('.plus-btn');
      
      if (minusBtn) {
        minusBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          this.changeQuantity(product.PRODUTO, -1);
        });
      }
      
      if (plusBtn) {
        plusBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          this.changeQuantity(product.PRODUTO, 1);
        });
      }
      
      this.productsGrid.appendChild(card);
    });
  }
  
  handleSearch(term) {
    const filteredProducts = term 
      ? this.products.filter(p => 
          p.PRODUTO.toLowerCase().includes(term.toLowerCase())
        )
      : this.products;
    
    this.renderProducts(filteredProducts);
  }
  
  toggleCartItem(productName) {
    const existingIndex = this.cart.findIndex(item => item.PRODUTO === productName);
    
    if (existingIndex >= 0) {
      this.cart.splice(existingIndex, 1);
      this.showNotification(`${productName} removido do carrinho`, 'danger');
    } else {
      const product = this.products.find(p => p.PRODUTO === productName);
      if (product) {
        this.cart.unshift({...product, quantity: 1});
        this.showNotification(`${productName} adicionado ao carrinho`, 'success');
      }
    }
    
    this.saveCartToCache(); // Salvar no cache
    this.updateCart();
    this.renderProducts(this.searchInput.value ? 
      this.products.filter(p => p.PRODUTO.toLowerCase().includes(this.searchInput.value.toLowerCase())) : 
      this.products
    );
  }
  
  changeQuantity(productName, delta) {
    const item = this.cart.find(item => item.PRODUTO === productName);
    if (item) {
      item.quantity = Math.max(1, item.quantity + delta);
      this.saveCartToCache(); // Salvar no cache
      this.updateCart();
      this.renderProducts(this.searchInput.value ? 
        this.products.filter(p => p.PRODUTO.toLowerCase().includes(this.searchInput.value.toLowerCase())) : 
        this.products
      );
    }
  }
  
  removeFromCart(productName) {
    this.cart = this.cart.filter(item => item.PRODUTO !== productName);
    this.saveCartToCache(); // Salvar no cache
    this.updateCart();
    this.renderProducts(this.searchInput.value ? 
      this.products.filter(p => p.PRODUTO.toLowerCase().includes(this.searchInput.value.toLowerCase())) : 
      this.products
    );
    this.showNotification(`${productName} removido do carrinho`, 'danger');
  }
  
  updateCart() {
    const totalItems = this.cart.reduce((sum, item) => sum + item.quantity, 0);
    
    // Update counters
    if (totalItems > 0) {
      this.cartCount.textContent = totalItems;
      this.cartCount.classList.remove('hidden');
      this.floatingCount.textContent = totalItems;
    } else {
      this.cartCount.classList.add('hidden');
      this.floatingCount.textContent = '0';
    }
    
    // Update cart items display
    this.renderCartItems();
    this.validateForm();
  }
  
  renderCartItems() {
    if (this.cart.length === 0) {
      this.cartItems.innerHTML = `
        <div class="cart-empty">
          <div style="font-size: 48px; margin-bottom: 16px;">🛒</div>
          <div>Seu carrinho está vazio</div>
          <div style="font-size: 14px; color: var(--gray); margin-top: 8px;">
            Adicione produtos para começar
          </div>
        </div>
      `;
      return;
    }
    
    this.cartItems.innerHTML = '';
    
    this.cart.forEach(item => {
      const div = document.createElement('div');
      div.className = 'cart-item slide-up';
      
      div.innerHTML = `
        <div class="cart-item-info">
          <div class="cart-item-name">${this.escapeHtml(item.PRODUTO)}</div>
        </div>
        <div class="cart-item-controls">
          <button class="cart-qty-btn minus-cart-btn" data-product="${this.escapeHtml(item.PRODUTO)}">−</button>
          <span class="cart-qty-display">${item.quantity}</span>
          <button class="cart-qty-btn plus-cart-btn" data-product="${this.escapeHtml(item.PRODUTO)}">+</button>
          <button class="cart-remove-btn" data-product="${this.escapeHtml(item.PRODUTO)}">×</button>
        </div>
      `;
      
      // Bind events (important: use event delegation to prevent cart closing)
      const minusBtn = div.querySelector('.minus-cart-btn');
      const plusBtn = div.querySelector('.plus-cart-btn');
      const removeBtn = div.querySelector('.cart-remove-btn');
      
      minusBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        this.changeQuantity(item.PRODUTO, -1);
      });
      
      plusBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        this.changeQuantity(item.PRODUTO, 1);
      });
      
      removeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        this.removeFromCart(item.PRODUTO);
      });
      
      this.cartItems.appendChild(div);
    });
  }
  
  openCart() {
    this.cartOverlay.classList.add('active');
    this.cartPanel.classList.add('active');
    this.floatingCart.classList.add('hidden');
    document.body.style.overflow = 'hidden';
  }
  
  closeCart() {
    this.cartOverlay.classList.remove('active');
    this.cartPanel.classList.remove('active');
    this.floatingCart.classList.remove('hidden');
    document.body.style.overflow = '';
  }
  
  openModal(imageSrc) {
    this.modalImage.src = imageSrc;
    this.imageModal.classList.add('active');
  }
  
  closeModal() {
    this.imageModal.classList.remove('active');
  }
  
  handleDeliveryOption(option) {
    if (option === 'ENTREGA') {
      this.deliveryForm.classList.remove('hidden');
      // Aguardar um frame para garantir que o elemento esteja visível
      setTimeout(() => {
        this.initializeMap();
      }, 100);
    } else {
      this.deliveryForm.classList.add('hidden');
    }
    this.validateForm();
  }
  
  handleAddressType(type) {
    const empresaContainer = document.getElementById('empresaContainer');
    if (type === 'CASA') {
      empresaContainer.classList.add('hidden');
    } else {
      empresaContainer.classList.remove('hidden');
    }
  }
  
  initializeMap() {
    if (this.map) return;
    
    const mapContainer = document.getElementById('map');
    if (!mapContainer || mapContainer.offsetWidth === 0) {
      console.log('Map container not ready, retrying...');
      setTimeout(() => this.initializeMap(), 200);
      return;
    }
    
    const defaultLat = -5.090000;
    const defaultLng = -42.811000;
    
    this.map = L.map(mapContainer).setView([defaultLat, defaultLng], 16);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors',
      maxZoom: 19
    }).addTo(this.map);
    
    this.marker = L.marker([defaultLat, defaultLng], { 
      draggable: true,
      riseOnHover: true 
    }).addTo(this.map);
    
    this.selectedLocation = this.marker.getLatLng();
    
    // Aguardar o mapa carregar completamente
    this.map.whenReady(() => {
      console.log('Map is ready');
      
      // Try to get user's location
      if (navigator.geolocation) {
        console.log('Requesting user location...');
        navigator.geolocation.getCurrentPosition(
          (position) => {
            console.log('Got user location:', position.coords);
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            this.map.setView([lat, lng], 16);
            this.marker.setLatLng([lat, lng]);
            this.selectedLocation = this.marker.getLatLng();
            this.fillAddressFromLocation(lat, lng);
            this.sendLocationToWebhook(lat, lng);
          },
          (error) => {
            console.log('Geolocation error:', error);
            this.fillAddressFromLocation(defaultLat, defaultLng);
          },
          {
            timeout: 10000,
            enableHighAccuracy: true,
            maximumAge: 300000 // 5 minutos
          }
        );
      } else {
        console.log('Geolocation not supported');
        this.fillAddressFromLocation(defaultLat, defaultLng);
      }
    });
    
    // Evento de arrastar o marcador
    this.marker.on('dragstart', () => {
      console.log('Marker drag started');
    });
    
    this.marker.on('dragend', (e) => {
      console.log('Marker drag ended');
      this.selectedLocation = e.target.getLatLng();
      console.log('New location:', this.selectedLocation);
      this.fillAddressFromLocation(this.selectedLocation.lat, this.selectedLocation.lng);
      this.sendLocationToWebhook(this.selectedLocation.lat, this.selectedLocation.lng);
    });
    
    // Forçar redimensionamento do mapa
    setTimeout(() => {
      this.map.invalidateSize();
    }, 300);
  }
  
  async fillAddressFromLocation(lat, lng) {
    console.log('Filling address for:', lat, lng);
    
    // Cancelar requisição anterior se existir
    if (this.addressFetchTimeout) {
      clearTimeout(this.addressFetchTimeout);
    }
    
    // Debounce para evitar muitas requisições
    this.addressFetchTimeout = setTimeout(async () => {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 segundos timeout
        
        const response = await fetch(
          `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&addressdetails=1&lang=pt-br&accept-language=pt-br,pt,en`,
          {
            signal: controller.signal,
            headers: {
              'User-Agent': 'KTech Store/1.0'
            }
          }
        );
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Address data received:', data);
        
        if (data && data.address) {
          const addr = data.address;
          
          // Limpar campos antes de preencher
          const streetField = document.getElementById('street');
          const neighborhoodField = document.getElementById('neighborhood');
          const houseNumberField = document.getElementById('houseNumber');
          const cityField = document.getElementById('city');
          
          if (streetField) streetField.value = '';
          if (neighborhoodField) neighborhoodField.value = '';
          if (houseNumberField) houseNumberField.value = '';
          if (cityField) cityField.value = '';
          
          // Preencher com novos dados
          if (addr.road && streetField) {
            streetField.value = addr.road;
            console.log('Street filled:', addr.road);
          }
          
          if (addr.house_number && houseNumberField) {
            houseNumberField.value = addr.house_number;
            console.log('House number filled:', addr.house_number);
          }
          
          // Tentar diferentes campos para o bairro
          const neighborhood = addr.suburb || addr.neighbourhood || addr.residential || addr.quarter || '';
          if (neighborhood && neighborhoodField) {
            neighborhoodField.value = neighborhood;
            console.log('Neighborhood filled:', neighborhood);
          }
          
          // Cidade
          const city = addr.city || addr.town || addr.municipality || addr.village || '';
          if (city && cityField) {
            cityField.value = city;
            console.log('City filled:', city);
          }
          
        } else {
          console.warn('No address data in response');
        }
        
      } catch (error) {
        console.error('Error fetching address:', error);
        
        // Em caso de erro, tentar um serviço alternativo
        try {
          const fallbackResponse = await fetch(
            `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=pt`
          );
          const fallbackData = await fallbackResponse.json();
          
          if (fallbackData) {
            const streetField = document.getElementById('street');
            const neighborhoodField = document.getElementById('neighborhood');
            const cityField = document.getElementById('city');
            
            if (fallbackData.locality && neighborhoodField) {
              neighborhoodField.value = fallbackData.locality;
            }
            
            if (fallbackData.city && cityField) {
              cityField.value = fallbackData.city;
            }
            
            console.log('Fallback address filled');
          }
        } catch (fallbackError) {
          console.error('Fallback geocoding also failed:', fallbackError);
        }
      }
    }, 500); // Aguarda 500ms antes de fazer a requisição
  }
  
  async sendLocationToWebhook(lat, lng) {
    try {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 5000);
      
      await fetch('https://webhookn8n.ktecheletronicos.com.br/webhook/location', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ latitude: lat, longitude: lng }),
        signal: controller.signal
      });
      
      clearTimeout(timeoutId);
    } catch (error) {
      console.error('Error sending location:', error);
    }
  }
  
  validateForm() {
    let nameValid = true;
    
    // Se nome veio por URL, usar ele
    if (this.customerNameFromUrl) {
      nameValid = /^[A-Za-zÀ-ÿ ]{12,}$/.test(this.customerNameFromUrl);
    } else {
      const nameInput = this.customerName;
      const nameError = document.getElementById('nameError');
      const name = nameInput.value.trim();
      nameValid = /^[A-Za-zÀ-ÿ ]{12,}$/.test(name);
      
      if (name && !nameValid) {
        nameError.classList.add('active');
        nameInput.classList.add('input-error');
      } else {
        nameError.classList.remove('active');
        nameInput.classList.remove('input-error');
      }
    }
    
    // Check if form is complete
    const isFormValid = nameValid && 
                       this.paymentMethod.value !== '' && 
                       this.cart.length > 0;
    
    this.whatsappBtn.disabled = !isFormValid;
    
    return isFormValid;
  }
  
handleFormSubmit(e) {
  e.preventDefault();
  e.stopPropagation();

  console.log('Form submit triggered');
  console.log('Cart items:', this.cart.length);

  if (!this.validateForm()) {
    console.log('Form validation failed');
    this.showNotification('Por favor, preencha todos os campos obrigatórios', 'danger');
    return;
  }

  if (this.cart.length === 0) {
    console.log('Cart is empty');
    this.showNotification('Adicione produtos ao carrinho primeiro', 'danger');
    return;
  }

  try {
    const customerName = this.customerNameFromUrl || this.customerName.value.trim();
    const paymentMethod = this.paymentMethod.value;
    const observations = document.getElementById('observations').value.trim();
    const deliveryOption = document.querySelector('input[name="deliveryOption"]:checked').value;

    let message = '🛒 *NOVO ORÇAMENTO - CATÁLOGO KTECH*\n\n';
    const totalItems = this.cart.reduce((sum, item) => sum + item.quantity, 0);
    message += `\n📦 *PRODUTOS* (${totalItems} itens):\n`;

    this.cart.forEach(item => {
      message += `• ${item.quantity}x ${item.PRODUTO}\n`;
    });

    if (observations) {
      message += `\n📝 *Observações:* ${observations}\n\n`;
    }

    if (deliveryOption === 'RETIRADA') {
      message += `\n👤 *Cliente:* ${customerName}\n`;
      message += '📍 *Entrega:* Retirada na loja\n';
    } else {
      const tipoEndereco = document.querySelector('input[name="tipoEndereco"]:checked')?.value || '';
      const empresaOuCondominio = document.getElementById('empresaOuCondominio').value || '';
      const street = document.getElementById('street').value || '';
      const houseNumber = document.getElementById('houseNumber').value || '';
      const neighborhood = document.getElementById('neighborhood').value || '';
      const city = document.getElementById('city').value || '';

      message += `👤 *Cliente:* ${customerName}\n`;
      message += '📍 *Entrega em endereço:*\n';

      if (empresaOuCondominio) {
        message += `${empresaOuCondominio} - `;
      }

      message += `${street}, ${houseNumber} - ${neighborhood} - ${city}\n`;

      if (this.selectedLocation) {
        message += `🗺️ *Localização:* https://maps.google.com/maps?q=${this.selectedLocation.lat},${this.selectedLocation.lng}\n`;
      }
    }

    message += `💳 *Pagamento:* ${paymentMethod}\n`;

    message += '\n\n⚠️ *Aguardando orçamento e confirmação dos valores finais.*';

    const whatsappUrl = `https://api.whatsapp.com/send?phone=558688519865&text=${encodeURIComponent(message)}`;

    console.log('Opening WhatsApp with URL:', whatsappUrl);

    this.showNotification('Redirecionando para o WhatsApp...', 'success');

    setTimeout(() => {
      window.open(whatsappUrl, '_blank');
    }, 500);

  } catch (error) {
    console.error('Error in form submit:', error);
    this.showNotification('Erro ao processar pedido. Tente novamente.', 'danger');
  }
}
  
  showNotification(message, type = 'success') {
    // Create notification element
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: ${type === 'success' ? 'var(--success)' : 'var(--danger)'};
      color: white;
      padding: 12px 20px;
      border-radius: var(--border-radius-sm);
      box-shadow: var(--shadow);
      z-index: 10000;
      font-weight: 600;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      max-width: calc(100vw - 40px);
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Show notification
    setTimeout(() => {
      notification.style.transform = 'translateX(0)';
    }, 100);
    
    // Hide notification
    setTimeout(() => {
      notification.style.transform = 'translateX(100%)';
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 300);
    }, 3000);
  }
  
  escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }
}

// Initialize the store when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
  new KTechStore();
});
</script>
</body>
</html>
